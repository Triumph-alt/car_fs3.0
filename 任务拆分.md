# 基于DMA的电感数据处理系统 - 任务拆分

## 模块拆分

### 1. 基础架构调整
- 调整ADC采样方式，从单次读取转为DMA批量采样
- 修改数据存储结构，适配DMA缓冲区格式
- 优化中断处理流程

### 2. 数据处理流程改造
- 简化/移除传统滤波算法
- 实现基于DMA平均值的归一化处理
- 优化位置计算算法

### 3. 测试与优化
- 对比新旧方案性能差异
- 调优DMA参数配置
- 稳定性测试与问题修复

## 详细任务列表

### 阶段一：DMA基础功能实现

| 任务编号 | 任务描述 | 优先级 | 状态 |
|---------|---------|-------|------|
| 1.1 | 调研STC32G的DMA-ADC功能，确定最佳配置参数 | 高 | |
| 1.2 | 修改ADC初始化代码，配置ADC工作参数 | 高 | |
| 1.3 | 修改DMA初始化代码，配置DMA通道、缓冲区 | 高 | |
| 1.4 | 实现DMA中断处理函数 | 高 | 完成 |
| 1.5 | 创建DMA数据读取函数，替代原有的get_adc函数 | 高 | |

### 阶段二：数据处理流程改造

| 任务编号 | 任务描述 | 优先级 | 状态 |
|---------|---------|-------|------|
| 2.1 | 重构归一化函数，直接使用DMA平均值 | 中 | |
| 2.2 | 删除或简化原有的滤波函数 | 中 | |
| 2.3 | 优化位置计算算法，适配新的数据格式 | 中 | |
| 2.4 | 更新赛道类型识别逻辑，适配新的数据处理流程 | 中 | |
| 2.5 | 修改电磁保护逻辑，确保与新系统兼容 | 中 | |
| 2.6 | 重构average_filter函数，实现DMA数据读取 | 高 | |
| 2.7 | 在average_filter中实现递推均值滤波逻辑 | 高 | |
| 2.8 | 优化DMA数据读取与滤波处理的同步机制 | 中 | |
| 2.9 | 测试average_filter在不同电感状态下的性能 | 中 | |

### 阶段三：测试与优化

| 任务编号 | 任务描述 | 优先级 | 状态 |
|---------|---------|-------|------|
| 3.1 | 开发测试用例，比较新旧方案的数据准确性 | 低 | |
| 3.2 | 优化DMA采样次数参数，寻找最佳平衡点 | 低 | |
| 3.3 | 进行实车测试，验证系统稳定性 | 低 | |
| 3.4 | 分析CPU负载变化，评估系统性能提升 | 低 | |
| 3.5 | 完善文档，总结经验教训 | 低 | |

## 开发注意事项

1. **兼容性考虑**
   - 确保新系统与现有代码的无缝集成
   - 保持关键接口不变，方便其他模块调用

2. **性能平衡**
   - DMA采样次数过多会增加延迟，过少会影响精度
   - 需找到最佳平衡点

3. **容错处理**
   - 添加DMA异常检测机制
   - 确保系统在异常情况下仍能降级运行

4. **可调试性**
   - 添加调试接口，便于观察DMA采样结果
   - 保留原有算法代码作为备选方案 

## 补充说明

1. **average_filter函数实现要点**
   - 函数应在main.c中的DmaADCFlag判断内调用，确保数据已更新
   - 从DmaAdBuffer读取数据时需考虑不同通道的映射关系
   - 递推均值滤波系数应根据实车测试结果调优
   - 滤波结果直接存入result数组，供归一化函数使用

2. **DMA通道与电感映射关系**
   - DmaAdBuffer[0] => HC (中间横向电感)
   - DmaAdBuffer[1] => HMR (右中横向电感)
   - DmaAdBuffer[2] => VR (右侧纵向电感)
   - DmaAdBuffer[3] => HR (右侧横向电感)
   - DmaAdBuffer[4] => HML (左中横向电感)
   - DmaAdBuffer[5] => VL (左侧纵向电感)
   - DmaAdBuffer[6] => HL (左侧横向电感)

3. **优先级安排**
   - 先完成average_filter的基本功能
   - 再优化滤波算法和同步机制
   - 最后进行全面测试和性能评估 