C251 COMPILER V5.60.0,  main                                                               15/07/25  15:29:34  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE main
OBJECT MODULE PLACED IN .\Out_File\main.obj
COMPILER INVOKED BY: D:\Software\Keil5\c251v560\C251\BIN\C251.EXE ..\USER\src\main.c LARGE INTR2 WARNINGLEVEL(3) OPTIMIZ
                    -E(0,SPEED) BROWSE INCDIR(..\USER\inc;..\USER\src;..\libraries;..\seekfree_libraries;..\seekfree_peripheral) DEBUG PRINT(
                    -.\Out_File\main.lst) OBJECT(.\Out_File\main.obj) 

stmt  level    source

    1          /*************  å¤´æ–‡ä»¶       **************/
    2          #include "headfile.h"
    3          #include "at24c16.h"
    4          #include "STC32G_ADC.h"
    5          #include "STC32G_DMA.h"
    6          #include "STC32G_Switch.h"
    7          
    8          
    9          /*************  å…¨å±€å˜é‡    **************/
   10          extern u8 xdata DmaAdBuffer[ADC_CH][ADC_DATA];
   11          extern float result[SENSOR_COUNT];       //æ»¤æ³¢åŽçš„ç”µæ„Ÿå€¼
   12          extern uint32 power_voltage;
   13          
   14          /*************  å‡½æ•°å£°æ˜Ž    **************/
   15          void PrintChAvg7(void);
   16          void ADC_config(void);
   17          void DMA_config(void);
   18          void GPIO_config(void);
   19          void PrintFiltered7(void);               // æ‰“å°æ»¤æ³¢åŽä¸ƒç”µæ„Ÿæ•°æ®
   20          void Printtest(void);            
   21          void PrintNormalized17(void);
   22          void PrintDebugData(void);
   23          
   24          /*************  ä¸»å‡½æ•°       **************/
   25          void main(void)
   26          {
   27   1              /*************  æœ¬åœ°å˜é‡å£°æ˜Ž      **************/
   28   1      
   29   1              /*************  ç³»ç»Ÿåˆå§‹åŒ– **************/
   30   1              board_init();                    // åˆå§‹åŒ–å¯„å­˜å™¨
   31   1              GPIO_config();                   //åˆå§‹åŒ–å¤–è®¾
   32   1              ADC_config();
   33   1              DMA_config();
   34   1              iic_init(IIC_2, IIC2_SCL_P25, IIC2_SDA_P24, 0);
   35   1              uart_init(UART_4, UART4_RX_P02, UART4_TX_P03, 115200, TIM_4);
   36   1              motor_init();
   37   1              encoder_init();
   38   1              imu963ra_init();
   39   1              oled_init();
   40   1      
   41   1              pit_timer_ms(TIM_1, 10);
   42   1              pit_timer_ms(TIM_2, 2);
   43   1      
   44   1              pid_init(&SpeedPID, 50.0f, 0.2f, 0.0f, 5000.0f, 6000.0f);      //åˆå§‹åŒ–é€Ÿåº¦PID
   45   1              pid_init(&TurnPID, 70.0f, 0.0f, 7.5f, 0.0f, 6000.0f);          //åˆå§‹åŒ–ä½ç½®PID
   46   1              lowpass_init(&leftSpeedFilt, 0.556);                          //åˆå§‹åŒ–ä½Žé€šæ»¤æ³¢å™¨
   47   1              lowpass_init(&rightSpeedFilt, 0.556);
   48   1              kalman_init(&imu693_kf, 0.98, 0.02, imu693kf_Q, imu693kf_R, 0.0);
   49   1              
   50   1          /* ä»ŽEEPROMåŠ è½½max_valueåŠPIDå‚æ•°ï¼Œè¦†ç›–é»˜è®¤å€¼ */
   51   1      //      load_parameters_from_eeprom();
   52   1      //      save_parameters_to_eeprom();  //ä¿å­˜max_valueåŠPIDå‚æ•°åˆ°EEPROMï¼ˆåˆå§‹åŒ–ï¼‰
   53   1      
   54   1              /*************  ä¸»å¾ªçŽ¯       **************/
   55   1          while(1)
   56   1              {
   57   2                      uart4_recv_task();  // ä¸²å£4æŽ¥æ”¶ä»»åŠ¡
C251 COMPILER V5.60.0,  main                                                               15/07/25  15:29:34  PAGE 2   

   58   2                      key_task();         // å¤„ç†æŒ‰é”®ä»»åŠ¡
   59   2      //              display_task();     // OLEDæ˜¾ç¤ºä»»åŠ¡
   60   2                      
   61   2                      /*************   å®šæ—¶æ“ä½œ   **************/
   62   2                      if (flag == 1)
   63   2                      {
   64   3      //                      if (g_speedpoint == 60)
   65   3      //                      {
   66   3      //                              g_speedpoint = 150;
   67   3      //                      }
   68   3      //                      else if (g_speedpoint == 150)
   69   3      //                      {
   70   3      //                              g_speedpoint = 60;
   71   3      //                      }
   72   3                              
   73   3                              flag = 0;
   74   3                      }
   75   2      
   76   2                      /*************  ADC DMAé‡‡æ ·å®Œæˆ     **************/
   77   2                      if(DmaADCFlag)  //åˆ¤æ–­ADC DMAé‡‡æ ·æ˜¯å¦å®Œæˆ
   78   2                      {
   79   3                              // ä½¿ç”¨average_filterè¯»å–DMAæ•°æ®å¹¶å®Œæˆé€’æŽ¨å‡å€¼æ»¤æ³¢
   80   3                              average_filter();
   81   3                              // é‡æ–°è§¦å‘DMAè¿›è¡Œä¸‹ä¸€æ¬¡è½¬æ¢
   82   3                              DMA_ADC_TRIG();
   83   3                      }
   84   2                      
   85   2                      //å½’ä¸€åŒ–ç”µæ„Ÿæ•°ç»„
   86   2                      normalize_sensors();
   87   2              
   88   2                      // è®¡ç®—ä½ç½®åå·®
   89   2                      position = calculate_position_improved();
   90   2                      
   91   2                      // æ£€æŸ¥ç”µç£ä¿æŠ¤
   92   2                      if (!protection_flag)
   93   2                              protection_flag = check_electromagnetic_protection();
   94   2                      
   95   2                      // æ‰“å°æ•°æ®
   96   2      //              PrintNormalized17(); //åŽŸå§‹æ•°æ®å’Œå½’ä¸€åŒ–
   97   2      //              PrintDebugData();        //è°ƒè¯•æ•°æ®
   98   2      //              PrintNormalized17();
   99   2                      Printtest();             //ç”µæ„Ÿå…ƒç´ åˆ¤åˆ«
  100   2          }
  101   1      }
  102          
  103          /*************  GPIO é…ç½®     **************/
  104          void GPIO_config(void)
  105          {
  106   1              gpio_mode(P0_0, GPI_IMPEDANCE);
  107   1              gpio_mode(P0_1, GPI_IMPEDANCE);
  108   1              gpio_mode(P0_5, GPI_IMPEDANCE);
  109   1              gpio_mode(P0_6, GPI_IMPEDANCE);
  110   1              gpio_mode(P1_1, GPI_IMPEDANCE);
  111   1              gpio_mode(P1_3, GPI_IMPEDANCE);
  112   1              gpio_mode(P1_4, GPI_IMPEDANCE);
  113   1              gpio_mode(P1_5, GPI_IMPEDANCE);
  114   1      }
  115          
  116          
  117          /*************  ADC é…ç½®      **************/
  118          void ADC_config(void)
  119          {
  120   1              ADC_InitTypeDef         ADC_InitStructure;              //ç»“æž„å®šä¹‰
  121   1      
  122   1              ADC_InitStructure.ADC_SMPduty   = 31;           //ADC æ¨¡æ‹Ÿä¿¡å·é‡‡æ ·æ—¶é—´æŽ§åˆ¶, 0~31ï¼ˆæ³¨æ„ï¼š SMPDUTY ä¸
             -€å®šä¸èƒ½è®¾ç½®å°äºŽ 10ï¼‰
C251 COMPILER V5.60.0,  main                                                               15/07/25  15:29:34  PAGE 3   

  123   1              ADC_InitStructure.ADC_CsSetup   = 0;            //ADC é€šé“é€‰æ‹©æ—¶é—´æŽ§åˆ¶ 0(é»˜è®¤),1
  124   1              ADC_InitStructure.ADC_CsHold    = 1;            //ADC é€šé“é€‰æ‹©ä¿æŒæ—¶é—´æŽ§åˆ¶ 0,1(é»˜è®¤),2,3
  125   1              ADC_InitStructure.ADC_Speed     = ADC_SPEED_2X16T;              //è®¾ç½® ADC å·¥ä½œæ—¶é’Ÿé¢‘çŽ‡ ADC_SPEED_2X1T~ADC_S
             -PEED_2X16T
  126   1              ADC_InitStructure.ADC_AdjResult = ADC_RIGHT_JUSTIFIED;  //ADCç»“æžœè°ƒæ•´,      ADC_LEFT_JUSTIFIED,ADC_RIGHT_J
             -USTIFIED
  127   1              ADC_Inilize(&ADC_InitStructure);                //åˆå§‹åŒ–
  128   1              ADC_PowerControl(ENABLE);                                               //ADCç”µæºå¼€å…³, ENABLEæˆ–DISABLE
  129   1              NVIC_ADC_Init(DISABLE,Priority_0);              //ä¸­æ–­ä½¿èƒ½, ENABLE/DISABLE; ä¼˜å…ˆçº§(ä½Žåˆ°é«˜) Priority_0,Prio
             -rity_1,Priority_2,Priority_3
  130   1      }
  131          
  132          /*************  DMA é…ç½®      **************/
  133          void DMA_config(void)
  134          {
  135   1              DMA_ADC_InitTypeDef             DMA_ADC_InitStructure;          //ç»“æž„å®šä¹‰
  136   1      
  137   1              DMA_ADC_InitStructure.DMA_Enable = ENABLE;                      //DMAä½¿èƒ½     ENABLE,DISABLE
  138   1              // DMA_ADC_InitStructure.DMA_Channel = 0xffff;         //ADCé€šé“ä½¿èƒ½å¯„å­˜å™¨, 1:ä½¿èƒ½, bit15~bit0 
             -å¯¹åº” ADC15~ADC0
  139   1              DMA_ADC_InitStructure.DMA_Channel = 0x633A;                     //ADCé€šé“ä½¿èƒ½: P0.0, P0.1, P0.5, P0.6, P1.1, P1.3, P1.
             -4
  140   1              DMA_ADC_InitStructure.DMA_Buffer = (u16)DmaAdBuffer;    //ADCè½¬æ¢æ•°æ®å­˜å‚¨åœ°å€
  141   1              DMA_ADC_InitStructure.DMA_Times = ADC_8_Times;  //æ¯ä¸ªé€šé“è½¬æ¢æ¬¡æ•°, ADC_1_Times,ADC_2_Times,ADC_4
             -_Times,ADC_8_Times,ADC_16_Times,ADC_32_Times,ADC_64_Times,ADC_128_Times,ADC_256_Times
  142   1              DMA_ADC_Inilize(&DMA_ADC_InitStructure);                //åˆå§‹åŒ–
  143   1              NVIC_DMA_ADC_Init(ENABLE,Priority_0,Priority_0);                //ä¸­æ–­ä½¿èƒ½, ENABLE/DISABLE; ä¼˜å…ˆçº§(ä½Žåˆ°é«˜) P
             -riority_0~Priority_3; æ€»çº¿ä¼˜å…ˆçº§(ä½Žåˆ°é«˜) Priority_0~Priority_3
  144   1              DMA_ADC_TRIG();         //è§¦å‘å¯åŠ¨è½¬æ¢
  145   1      }
  146          
  147          
  148          /*************  æ‰“å°ç”µæ„ŸåŽŸå§‹æ•°æ®        **************/
  149          void PrintChAvg7(void)  
  150          {
  151   1          // ä¸€æ¬¡æ€§æ‰“å°å‰ 7 ä¸ªé€šé“çš„å¹³å‡å€¼ (å‡è®¾ ADC_CH >= 7)
  152   1          u16 HC  = ((u16)DmaAdBuffer[0][2*ADC_TIMES+2] << 8) | DmaAdBuffer[0][2*ADC_TIMES+3]; //1
  153   1          u16 HMR = ((u16)DmaAdBuffer[1][2*ADC_TIMES+2] << 8) | DmaAdBuffer[1][2*ADC_TIMES+3]; //3
  154   1          u16 VR  = ((u16)DmaAdBuffer[2][2*ADC_TIMES+2] << 8) | DmaAdBuffer[2][2*ADC_TIMES+3]; //4
  155   1          u16 HR  = ((u16)DmaAdBuffer[3][2*ADC_TIMES+2] << 8) | DmaAdBuffer[3][2*ADC_TIMES+3]; //8
  156   1          u16 HML = ((u16)DmaAdBuffer[4][2*ADC_TIMES+2] << 8) | DmaAdBuffer[4][2*ADC_TIMES+3]; //9
  157   1          u16 VL  = ((u16)DmaAdBuffer[5][2*ADC_TIMES+2] << 8) | DmaAdBuffer[5][2*ADC_TIMES+3]; //13
  158   1          u16 HL  = ((u16)DmaAdBuffer[6][2*ADC_TIMES+2] << 8) | DmaAdBuffer[6][2*ADC_TIMES+3]; //14
  159   1      
  160   1          sprintf(g_txbuffer,"%u,%u,%u,%u,%u,%u,%u\r\n",
  161   1                 HL, VL, HML, HC, HMR, VR, HR);
  162   1          uart_putstr(UART_4, g_txbuffer);
  163   1      }
  164          
  165          /*************  æ‰“å°æ»¤æ³¢åŽç”µæ„Ÿæ•°æ®     **************/
  166          void PrintFiltered7(void)
  167          {
  168   1          // å°† float è½¬ä¸ºæ— ç¬¦å·æ•´æ•°æ‰“å°ï¼Œä¾¿äºŽä¸²å£è°ƒè¯•
  169   1          sprintf(g_txbuffer, "%u,%u,%u,%u,%u,%u,%u\r\n",
  170   1                  (uint16)result[SENSOR_HL],
  171   1                  (uint16)result[SENSOR_VL],
  172   1                  (uint16)result[SENSOR_HML],
  173   1                  (uint16)result[SENSOR_HC],
  174   1                  (uint16)result[SENSOR_HMR],
  175   1                  (uint16)result[SENSOR_VR],
  176   1                  (uint16)result[SENSOR_HR]);
  177   1          uart_putstr(UART_4, g_txbuffer);
  178   1      }
  179          
  180          /*************  æ‰“å°ç”µæ„Ÿå…ƒç´ åˆ¤åˆ«æ•°æ®  **************/
  181          void Printtest(void)
C251 COMPILER V5.60.0,  main                                                               15/07/25  15:29:34  PAGE 4   

  182          {
  183   1          // å°†å½’ä¸€åŒ–åŽçš„floatæ•°æ®æ‰“å°ï¼Œä¿ç•™ä¸¤ä½å°æ•°
  184   1          sprintf(g_txbuffer, "%u,%u,%u,%u,%u,%u,%u,%u,%d,%u,%u,%u,%d\r\n",
  185   1                  (uint16)normalized_data[SENSOR_HL],
  186   1                  (uint16)normalized_data[SENSOR_VL],
  187   1                  (uint16)normalized_data[SENSOR_HML],
  188   1                  (uint16)normalized_data[SENSOR_HC],
  189   1                  (uint16)normalized_data[SENSOR_HMR],
  190   1                  (uint16)normalized_data[SENSOR_VR],
  191   1                  (uint16)normalized_data[SENSOR_HR],
  192   1                              (uint16)signal_strength_value,
  193   1                      position,
  194   1                              track_type,
  195   1      //                      track_type_zj
  196   1                              track_route,
  197   1                              track_route_status,
  198   1                              g_intencoderALL
  199   1                              );
  200   1          uart_putstr(UART_4, g_txbuffer);
  201   1      }
  202          
  203          /*************  æ‰“å°åŽŸå§‹å’Œå½’ä¸€åŒ–æ•°æ®  **************/
  204          void PrintNormalized17(void)
  205          {
  206   1          // å°†å½’ä¸€åŒ–åŽçš„floatæ•°æ®æ‰“å°ï¼Œä¿ç•™ä¸¤ä½å°æ•°
  207   1          sprintf(g_txbuffer, "%u,%u,%u,%u,%u,%u,%u,%u,%u,%u,%u,%u,%u,%u,%d\r\n",
  208   1                  (uint16)result[SENSOR_HL],
  209   1                  (uint16)result[SENSOR_VL],
  210   1                  (uint16)result[SENSOR_HML],
  211   1                  (uint16)result[SENSOR_HC],
  212   1                  (uint16)result[SENSOR_HMR],
  213   1                  (uint16)result[SENSOR_VR],
  214   1                  (uint16)result[SENSOR_HR],
  215   1                  (uint16)normalized_data[SENSOR_HL],
  216   1                  (uint16)normalized_data[SENSOR_VL],
  217   1                  (uint16)normalized_data[SENSOR_HML],
  218   1                  (uint16)normalized_data[SENSOR_HC],
  219   1                  (uint16)normalized_data[SENSOR_HMR],
  220   1                  (uint16)normalized_data[SENSOR_VR],
  221   1                  (uint16)normalized_data[SENSOR_HR],
  222   1                  position);
  223   1          uart_putstr(UART_4, g_txbuffer);
  224   1      }
  225          
  226          /*************  æ‰“å°è°ƒè¯•æ•°æ®      **************/
  227          void PrintDebugData(void)
  228          {
  229   1          if (uartSendFlag == 1)
  230   1              {
  231   2                      sprintf(g_txbuffer, "%d,%d,%d,%d,%d,%d,%d,%d,%d,%d\n", 
  232   2                                      g_speedpoint, 
  233   2                                      g_encoder_average, 
  234   2                                      EncoderL.encoder_final,
  235   2                                      EncoderR.encoder_final,
  236   2                                      (int)g_DutyLeft,
  237   2                                      (int)g_DutyRight,
  238   2                                      position,
  239   2                                      (int)speed_pid,
  240   2                                      (int)turn_pid,
  241   2                                      (uint16)power_voltage);
  242   2                      uart_putstr(UART_4, g_txbuffer);
  243   2                                      
  244   2                      if (position >= 0)
  245   2                              P52 = 1;
  246   2                      else
  247   2                              P52 = 0;
C251 COMPILER V5.60.0,  main                                                               15/07/25  15:29:34  PAGE 5   

  248   2              }
  249   1      }
  250          


Module Information          Static   Overlayable
------------------------------------------------
  code size            =      1973     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =        25     ------
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =       144     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
