C251 COMPILER V5.60.0,  main                                                               10/07/25  18:50:48  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE main
OBJECT MODULE PLACED IN .\Out_File\main.obj
COMPILER INVOKED BY: D:\Software\Keil5\c251v560\C251\BIN\C251.EXE ..\USER\src\main.c LARGE INTR2 WARNINGLEVEL(3) OPTIMIZ
                    -E(0,SPEED) BROWSE INCDIR(..\USER\inc;..\USER\src;..\libraries;..\seekfree_libraries;..\seekfree_peripheral) DEBUG PRINT(
                    -.\Out_File\main.lst) TABS(2) OBJECT(.\Out_File\main.obj) 

stmt  level    source

    1          /*************  å¤´æ–‡ä»¶ **************/
    2          #include "headfile.h"
    3          #include "at24c16.h"
    4          #include "STC32G_ADC.h"
    5          #include "STC32G_DMA.h"
    6          #include "STC32G_Switch.h"
    7          
    8          
    9          /*************  å…¨å±€å˜é‡  **************/
   10          extern u8 chn;
   11          extern u8 xdata DmaAdBuffer[ADC_CH][ADC_DATA];
   12          uint8_t g_TxData[200] = {0};
   13          extern float result[SENSOR_COUNT];       // æ¥è‡ª electromagnetic_tracking.c çš„æ»¤æ³¢ç»“æžœæ•°ç»„
   14          
   15          
   16          /*************  å‡½æ•°å£°æ˜Ž  **************/
   17          void PrintChAvg7(void);
   18          void ADC_config(void);
   19          void DMA_config(void);
   20          void GPIO_config(void);
   21          void PrintFiltered7(void);               // æ‰“å°æ»¤æ³¢åŽä¸ƒç”µæ„Ÿæ•°æ®
   22          void PrintNormalized7(void);             // æ‰“å°å½’ä¸€åŒ–åŽä¸ƒç”µæ„Ÿæ•°æ®
   23          
   24          
   25          /*************  ä¸»å‡½æ•° **************/
   26          void main(void)
   27          {
   28   1        /*************  æœ¬åœ°å˜é‡å£°æ˜Ž  **************/
   29   1        int state = 5;
   30   1        uint16 sum_value = 0;    
   31   1        uint16 value[7] = {0};   //è°ƒè¯•ç”¨æ•°ç»„
   32   1      
   33   1        /*************  ç³»ç»Ÿåˆå§‹åŒ– **************/
   34   1        board_init();      // åˆå§‹åŒ–å¯„å­˜å™¨
   35   1        GPIO_config();       //åˆå§‹åŒ–å¤–è®¾
   36   1        ADC_config();
   37   1        DMA_config();
   38   1        iic_init(IIC_2, IIC2_SCL_P25, IIC2_SDA_P24, 0);
   39   1        uart_init(UART_4, UART4_RX_P02, UART4_TX_P03, 115200, TIM_4);
   40   1        motor_init();
   41   1        encoder_init();
   42   1        imu963ra_init();
   43   1        oled_init();
   44   1      
   45   1        pit_timer_ms(TIM_1, 10);
   46   1        pit_timer_ms(TIM_2, 5);
   47   1      
   48   1        pid_init(&SpeedPID, 1.0f, 2.0f, 3.0f, 5000.0f, 6000.0f); //åˆå§‹åŒ–é€Ÿåº¦PID
   49   1        pid_init(&TurnPID, 1.0f, 2.0f, 3.0f, 0.0f, 6000.0f);  //åˆå§‹åŒ–ä½ç½®PID
   50   1        lowpass_init(&leftSpeedFilt, 0.556);   //åˆå§‹åŒ–ä½Žé€šæ»¤æ³¢å™¨
   51   1        lowpass_init(&rightSpeedFilt, 0.556);
   52   1        kalman_init(&imu693_kf, 0.98, 0.02, imu693kf_Q, imu693kf_R, 0.0);
   53   1        
   54   1          /* ä»ŽEEPROMåŠ è½½max_valueåŠPIDå‚æ•°ï¼Œè¦†ç›–é»˜è®¤å€¼ */
   55   1         load_parameters_from_eeprom();
   56   1      //  save_parameters_to_eeprom();  //ä¿å­˜max_valueåŠPIDå‚æ•°åˆ°EEPROMï¼ˆåˆå§‹åŒ–ï¼‰
   57   1      
C251 COMPILER V5.60.0,  main                                                               10/07/25  18:50:48  PAGE 2   

   58   1        /*************  ä¸»å¾ªçŽ¯ **************/
   59   1          while(1)
   60   1        {
   61   2          uart4_recv_task();  // ä¸²å£4æŽ¥æ”¶ä»»åŠ¡
   62   2      //     key_task();         // å¤„ç†æŒ‰é”®ä»»åŠ¡
   63   2      //     display_task();     // OLEDæ˜¾ç¤ºä»»åŠ¡
   64   2      
   65   2          /*************  ADC DMAé‡‡æ ·å®Œæˆ **************/
   66   2          if(DmaADCFlag)  //åˆ¤æ–­ADC DMAé‡‡æ ·æ˜¯å¦å®Œæˆ
   67   2          {
   68   3            // ä½¿ç”¨average_filterè¯»å–DMAæ•°æ®å¹¶å®Œæˆé€’æŽ¨å‡å€¼æ»¤æ³¢
   69   3            average_filter();
   70   3            // é‡æ–°è§¦å‘DMAè¿›è¡Œä¸‹ä¸€æ¬¡è½¬æ¢
   71   3            DMA_ADC_TRIG();
   72   3          }
   73   2          
   74   2          // PrintFiltered7();
   75   2      
   76   2          // å½’ä¸€åŒ–ç”µæ„Ÿæ•°ç»„
   77   2          normalize_sensors();
   78   2        
   79   2          // è®¡ç®—ä½ç½®åå·®
   80   2           position = calculate_position_improved();
   81   2      
   82   2          // æ‰“å°å½’ä¸€åŒ–åŽçš„ç”µæ„Ÿæ•°æ®
   83   2          PrintNormalized7();
   84   2          
   85   2          // æ£€æŸ¥ç”µç£ä¿æŠ¤
   86   2          // protection_flag = check_electromagnetic_protection();
   87   2          
   88   2          }
   89   1      }
   90          
   91          /*************  GPIO é…ç½® **************/
   92          void GPIO_config(void)
   93          {
   94   1        gpio_mode(P0_0, GPI_IMPEDANCE);
   95   1        gpio_mode(P0_1, GPI_IMPEDANCE);
   96   1        gpio_mode(P0_5, GPI_IMPEDANCE);
   97   1        gpio_mode(P0_6, GPI_IMPEDANCE);
   98   1        gpio_mode(P1_1, GPI_IMPEDANCE);
   99   1        gpio_mode(P1_3, GPI_IMPEDANCE);
  100   1        gpio_mode(P1_4, GPI_IMPEDANCE);
  101   1      }
  102          
  103          
  104          /*************  ADC é…ç½®  **************/
  105          void ADC_config(void)
  106          {
  107   1        ADC_InitTypeDef   ADC_InitStructure;    //ç»“æž„å®šä¹‰
  108   1      
  109   1        ADC_InitStructure.ADC_SMPduty   = 31;   //ADC æ¨¡æ‹Ÿä¿¡å·é‡‡æ ·æ—¶é—´æŽ§åˆ¶, 0~31ï¼ˆæ³¨æ„ï¼š SMPDUTY ä¸
             -€å®šä¸èƒ½è®¾ç½®å°äºŽ 10ï¼‰
  110   1        ADC_InitStructure.ADC_CsSetup   = 0;    //ADC é€šé“é€‰æ‹©æ—¶é—´æŽ§åˆ¶ 0(é»˜è®¤),1
  111   1        ADC_InitStructure.ADC_CsHold    = 1;    //ADC é€šé“é€‰æ‹©ä¿æŒæ—¶é—´æŽ§åˆ¶ 0,1(é»˜è®¤),2,3
  112   1        ADC_InitStructure.ADC_Speed     = ADC_SPEED_2X16T;    //è®¾ç½® ADC å·¥ä½œæ—¶é’Ÿé¢‘çŽ‡ ADC_SPEED_2X1T~ADC_S
             -PEED_2X16T
  113   1        ADC_InitStructure.ADC_AdjResult = ADC_RIGHT_JUSTIFIED;  //ADCç»“æžœè°ƒæ•´,  ADC_LEFT_JUSTIFIED,ADC_RIGHT_J
             -USTIFIED
  114   1        ADC_Inilize(&ADC_InitStructure);    //åˆå§‹åŒ–
  115   1        ADC_PowerControl(ENABLE);           //ADCç”µæºå¼€å…³, ENABLEæˆ–DISABLE
  116   1        NVIC_ADC_Init(DISABLE,Priority_0);    //ä¸­æ–­ä½¿èƒ½, ENABLE/DISABLE; ä¼˜å…ˆçº§(ä½Žåˆ°é«˜) Priority_0,Prio
             -rity_1,Priority_2,Priority_3
  117   1      }
  118          
  119          /*************  DMA é…ç½®  **************/
C251 COMPILER V5.60.0,  main                                                               10/07/25  18:50:48  PAGE 3   

  120          void DMA_config(void)
  121          {
  122   1        DMA_ADC_InitTypeDef   DMA_ADC_InitStructure;    //ç»“æž„å®šä¹‰
  123   1      
  124   1        DMA_ADC_InitStructure.DMA_Enable = ENABLE;      //DMAä½¿èƒ½   ENABLE,DISABLE
  125   1        // DMA_ADC_InitStructure.DMA_Channel = 0xffff;         //ADCé€šé“ä½¿èƒ½å¯„å­˜å™¨, 1:ä½¿èƒ½, bit15~bit0 
             -å¯¹åº” ADC15~ADC0
  126   1        DMA_ADC_InitStructure.DMA_Channel = 0x631A;     //ADCé€šé“ä½¿èƒ½: P0.0, P0.1, P0.5, P0.6, P1.1, P1.3, P1.
             -4
  127   1        DMA_ADC_InitStructure.DMA_Buffer = (u16)DmaAdBuffer;  //ADCè½¬æ¢æ•°æ®å­˜å‚¨åœ°å€
  128   1        DMA_ADC_InitStructure.DMA_Times = ADC_8_Times;  //æ¯ä¸ªé€šé“è½¬æ¢æ¬¡æ•°, ADC_1_Times,ADC_2_Times,ADC_4
             -_Times,ADC_8_Times,ADC_16_Times,ADC_32_Times,ADC_64_Times,ADC_128_Times,ADC_256_Times
  129   1        DMA_ADC_Inilize(&DMA_ADC_InitStructure);    //åˆå§‹åŒ–
  130   1        NVIC_DMA_ADC_Init(ENABLE,Priority_0,Priority_0);    //ä¸­æ–­ä½¿èƒ½, ENABLE/DISABLE; ä¼˜å…ˆçº§(ä½Žåˆ°é«˜) P
             -riority_0~Priority_3; æ€»çº¿ä¼˜å…ˆçº§(ä½Žåˆ°é«˜) Priority_0~Priority_3
  131   1        DMA_ADC_TRIG();   //è§¦å‘å¯åŠ¨è½¬æ¢
  132   1      }
  133          
  134          
  135          /*************  æ‰“å°ç”µæ„ŸåŽŸå§‹æ•°æ®  **************/
  136          void PrintChAvg7(void)  
  137          {
  138   1          // ä¸€æ¬¡æ€§æ‰“å°å‰ 7 ä¸ªé€šé“çš„å¹³å‡å€¼ (å‡è®¾ ADC_CH >= 7)
  139   1          u16 HC  = ((u16)DmaAdBuffer[0][2*ADC_TIMES+2] << 8) | DmaAdBuffer[0][2*ADC_TIMES+3]; //1
  140   1          u16 HMR = ((u16)DmaAdBuffer[1][2*ADC_TIMES+2] << 8) | DmaAdBuffer[1][2*ADC_TIMES+3]; //3
  141   1          u16 VR  = ((u16)DmaAdBuffer[2][2*ADC_TIMES+2] << 8) | DmaAdBuffer[2][2*ADC_TIMES+3]; //4
  142   1          u16 HR  = ((u16)DmaAdBuffer[3][2*ADC_TIMES+2] << 8) | DmaAdBuffer[3][2*ADC_TIMES+3]; //8
  143   1          u16 HML = ((u16)DmaAdBuffer[4][2*ADC_TIMES+2] << 8) | DmaAdBuffer[4][2*ADC_TIMES+3]; //9
  144   1          u16 VL  = ((u16)DmaAdBuffer[5][2*ADC_TIMES+2] << 8) | DmaAdBuffer[5][2*ADC_TIMES+3]; //13
  145   1          u16 HL  = ((u16)DmaAdBuffer[6][2*ADC_TIMES+2] << 8) | DmaAdBuffer[6][2*ADC_TIMES+3]; //14
  146   1      
  147   1          sprintf(g_TxData,"%u,%u,%u,%u,%u,%u,%u\r\n",
  148   1                 HL, VL, HML, HC, HMR, VR, HR);
  149   1          uart_putstr(UART_4, g_TxData);
  150   1          delay_ms(10);
  151   1      }
  152          
  153          /*************  æ‰“å°æ»¤æ³¢åŽç”µæ„Ÿæ•°æ® **************/
  154          void PrintFiltered7(void)
  155          {
  156   1          // å°† float è½¬ä¸ºæ— ç¬¦å·æ•´æ•°æ‰“å°ï¼Œä¾¿äºŽä¸²å£è°ƒè¯•
  157   1          sprintf(g_TxData, "%u,%u,%u,%u,%u,%u,%u\r\n",
  158   1                  (uint16)result[SENSOR_HL],
  159   1                  (uint16)result[SENSOR_VL],
  160   1                  (uint16)result[SENSOR_HML],
  161   1                  (uint16)result[SENSOR_HC],
  162   1                  (uint16)result[SENSOR_HMR],
  163   1                  (uint16)result[SENSOR_VR],
  164   1                  (uint16)result[SENSOR_HR]);
  165   1          uart_putstr(UART_4, g_TxData);
  166   1          delay_ms(10);
  167   1      }
  168          
  169          /*************  æ‰“å°å½’ä¸€åŒ–åŽç”µæ„Ÿæ•°æ®  **************/
  170          void PrintNormalized7(void)
  171          {
  172   1          // å°†å½’ä¸€åŒ–åŽçš„floatæ•°æ®æ‰“å°ï¼Œä¿ç•™ä¸¤ä½å°æ•°
  173   1          sprintf(g_TxData, "%u,%u,%u,%u,%u,%u,%u,%d\r\n",
  174   1                  (uint16)normalized_data[SENSOR_HL],
  175   1                  (uint16)normalized_data[SENSOR_VL],
  176   1                  (uint16)normalized_data[SENSOR_HML],
  177   1                  (uint16)normalized_data[SENSOR_HC],
  178   1                  (uint16)normalized_data[SENSOR_HMR],
  179   1                  (uint16)normalized_data[SENSOR_VR],
  180   1                  (uint16)normalized_data[SENSOR_HR],
  181   1                  position);
C251 COMPILER V5.60.0,  main                                                               10/07/25  18:50:48  PAGE 4   

  182   1          uart_putstr(UART_4, g_TxData);
  183   1          delay_ms(10);
  184   1      }
  185          
  186          


Module Information          Static   Overlayable
------------------------------------------------
  code size            =      1397     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =       243     ------
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =       270     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
