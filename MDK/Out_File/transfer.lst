C251 COMPILER V5.60.0,  transfer                                                           18/07/25  23:03:16  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE transfer
OBJECT MODULE PLACED IN .\Out_File\transfer.obj
COMPILER INVOKED BY: D:\Software\Keil5\c251v560\C251\BIN\C251.EXE ..\USER\src\transfer.c LARGE INTR2 WARNINGLEVEL(3) OPT
                    -IMIZE(0,SPEED) BROWSE INCDIR(..\USER\inc;..\USER\src;..\libraries;..\seekfree_libraries;..\seekfree_peripheral) DEBUG PR
                    -INT(.\Out_File\transfer.lst) OBJECT(.\Out_File\transfer.obj) 

stmt  level    source

    1          #include "transfer.h"
    2          #include "OLED.h"
    3          #include "electromagnetic_tracking.h"
    4          #include "pid.h"
    5          #include "at24c16.h"
    6          
    7          extern float result[7]; // 声明外部变量
    8          // 声明环岛相关的外部变量
    9          extern volatile uint8_t intoisland_pos;            // 入环岛的偏差
   10          extern volatile uint16_t intoisland_str_dist;      // 入环岛直走距离
   11          extern volatile uint16_t intoisland_all_dist;      // 入环岛总距离
   12          extern volatile uint8_t outisland_pos;             // 出环岛的偏差
   13          extern volatile uint16_t outisland_turn_dist;      // 出环岛拐弯距离
   14          extern volatile uint16_t outisland_all_dist;       // 出环岛总距离
   15          
   16          extern uint32 power_voltage; // 电池电压（毫伏）
   17          
   18          Key_t key[4] = {0, 0, 0, 0};
   19          enum state car_state, prev_state; 
   20          uint8 selected_item = 0; // 当前选中的项目索引
   21          
   22          uint8_t startKeyFlag = 0, uartSendFlag = 1;
   23          
   24          void key_task(void)
   25          {
   26   1              if (key[0].flag == 1)
   27   1              {
   28   2             prev_state = car_state;   // 记录切换前状态
   29   2             if (car_state < CHARGE)
   30   2             {
   31   3                 car_state++;
   32   3                 oled_clear();
   33   3                 selected_item = 0; // 切换状态时重置选中项
   34   3      
   35   3                 /* 若从 ISLAND_PARA 切换到 CHARGE，保存参数 */
   36   3                 if(prev_state == ISLAND_PARA && car_state == CHARGE)
   37   3                 {
   38   4                     save_parameters_to_eeprom();
   39   4                 }
   40   3             }
   41   2                      
   42   2                      // if (startKeyFlag == 1)
   43   2                      // {
   44   2                      //      set_motor_pwm(0, 0);
   45   2      
   46   2                      //      pid_clean(&SpeedPID);
   47   2                      //      pid_clean(&TurnPID);
   48   2                              
   49   2                      //      uartSendFlag = startKeyFlag = 0;
   50   2                      // }
   51   2                      // else
   52   2                      // {
   53   2                      //      delay_ms(2000);
   54   2                      //      uartSendFlag = startKeyFlag = 1;
   55   2                      // }
   56   2                      
   57   2                      key[0].flag = 0;
C251 COMPILER V5.60.0,  transfer                                                           18/07/25  23:03:16  PAGE 2   

   58   2              }
   59   1      
   60   1              if (key[1].flag == 1)
   61   1              {
   62   2              // 按键1作为选择按键
   63   2              switch (car_state)
   64   2              {
   65   3                  case ELECT_PARA:
   66   3                      // 在电感参数界面，最多7个选项(max_value数组)
   67   3                      selected_item = (selected_item + 1) % 7;
   68   3                      break;
   69   3                      
   70   3                  case PID_PARA:
   71   3                      // 在PID参数界面，最多6个选项(SpeedPID和TurnPID的kp,ki,kd)
   72   3                      selected_item = (selected_item + 1) % 6;
   73   3                      break;
   74   3                      
   75   3                  case ISLAND_PARA:
   76   3                      // 在环岛参数界面，最多6个选项
   77   3                      selected_item = (selected_item + 1) % 6;
   78   3                      break;
   79   3                      
   80   3                  default:
   81   3                      break;
   82   3              }
   83   2                      
   84   2                      key[1].flag = 0;
   85   2              }
   86   1      
   87   1              if (key[2].flag == 1)
   88   1              {
   89   2              // 按键2作为增加值的按键
   90   2              switch (car_state)
   91   2              {
   92   3                  case ELECT_PARA:
   93   3                      // 增加选中的max_value值
   94   3                      if (selected_item < 7)
   95   3                      {
   96   4                          max_value[selected_item] += 10; // 每次增加10
   97   4                      }
   98   3                      break;
   99   3                      
  100   3                  case PID_PARA:
  101   3                      // 增加选中的PID参数
  102   3                      if (selected_item == 0) SpeedPID.kp += 0.1f;
  103   3                      else if (selected_item == 1) SpeedPID.ki += 0.1f;
  104   3                      else if (selected_item == 2) TurnPID.kp += 0.1f;
  105   3                      else if (selected_item == 3) TurnPID.kd += 0.1f;
  106   3                      else if (selected_item == 4) angle_kp += 0.1f;
  107   3                      else if (selected_item == 5) angle_kd += 0.1f;
  108   3                      break;
  109   3                      
  110   3                  case ISLAND_PARA:
  111   3                      // 增加环岛参数
  112   3                      if (selected_item == 0) intoisland_pos += 1;
  113   3                      else if (selected_item == 1) intoisland_str_dist += 100;
  114   3                      else if (selected_item == 2) intoisland_all_dist += 100;
  115   3                      else if (selected_item == 3) outisland_pos += 1;
  116   3                      else if (selected_item == 4) outisland_turn_dist += 100;
  117   3                      else if (selected_item == 5) outisland_all_dist += 100;
  118   3                      break;
  119   3                      
  120   3                  default:
  121   3                      break;
  122   3              }
  123   2                      
C251 COMPILER V5.60.0,  transfer                                                           18/07/25  23:03:16  PAGE 3   

  124   2                      key[2].flag = 0;
  125   2              }
  126   1      
  127   1              if (key[3].flag == 1)
  128   1              {
  129   2              // 按键3作为减少值的按键
  130   2              switch (car_state)
  131   2              {
  132   3                  case ELECT_PARA:
  133   3                      // 减少选中的max_value值
  134   3                      if (selected_item < 7 && max_value[selected_item] >= 10)
  135   3                      {
  136   4                          max_value[selected_item] -= 10; // 每次减少10
  137   4                      }
  138   3                      break;
  139   3                      
  140   3                  case PID_PARA:
  141   3                      // 减少选中的PID参数
  142   3                      if (selected_item == 0 && SpeedPID.kp >= 0.1f) SpeedPID.kp -= 0.1f;
  143   3                      else if (selected_item == 1 && SpeedPID.ki >= 0.1f) SpeedPID.ki -= 0.1f;
  144   3                      else if (selected_item == 2 && TurnPID.kp >= 0.1f) TurnPID.kp -= 0.1f;
  145   3                      else if (selected_item == 3 && TurnPID.kd >= 0.1f) TurnPID.kd -= 0.1f;
  146   3                      else if (selected_item == 4 && angle_kp >= 0.1f) angle_kp -= 0.1f;
  147   3                      else if (selected_item == 5 && angle_kd >= 0.1f) angle_kd -= 0.1f;
  148   3                      break;
  149   3                      
  150   3                  case ISLAND_PARA:
  151   3                      // 减少环岛参数
  152   3                      if (selected_item == 0 && intoisland_pos > 1) intoisland_pos -= 1;
  153   3                      else if (selected_item == 1 && intoisland_str_dist >= 100) intoisland_str_dist -= 100;
  154   3                      else if (selected_item == 2 && intoisland_all_dist >= 100) intoisland_all_dist -= 100;
  155   3                      else if (selected_item == 3 && outisland_pos > 1) outisland_pos -= 1;
  156   3                      else if (selected_item == 4 && outisland_turn_dist >= 100) outisland_turn_dist -= 100;
  157   3                      else if (selected_item == 5 && outisland_all_dist >= 100) outisland_all_dist -= 100;
  158   3                      break;
  159   3                      
  160   3                  default:
  161   3                      break;
  162   3              }
  163   2                      
  164   2                      key[3].flag = 0;
  165   2              }
  166   1      }
  167          
  168          /* 8行，21列*/
  169          void display_task(void)
  170          {
  171   1          switch (car_state)
  172   1          {
  173   2              case ELECT_PARA:
  174   2                  {
  175   3                      oled_show_string(1, 8, "max_v");
  176   3                      oled_show_string(1, 14, "real_v");
  177   3                      
  178   3                      // 显示电感名称，选中项前添加'>'标记
  179   3                      oled_show_string(2, 1, selected_item == 0 ? ">HL:" : "HL: ");
  180   3                      oled_show_string(3, 1, selected_item == 1 ? ">VL:" : "VL: ");
  181   3                      oled_show_string(4, 1, selected_item == 2 ? ">HML:" : "HML: ");
  182   3                      oled_show_string(5, 1, selected_item == 3 ? ">HC:" : "HC: ");
  183   3                      oled_show_string(6, 1, selected_item == 4 ? ">HMR:" : "HMR: ");
  184   3                      oled_show_string(7, 1, selected_item == 5 ? ">VR:" : "VR: ");
  185   3                      oled_show_string(8, 1, selected_item == 6 ? ">HR:" : "HR: ");
  186   3      
  187   3                      oled_show_num(2, 8, max_value[0], 4);
  188   3                      oled_show_num(3, 8, max_value[1], 4);
  189   3                      oled_show_num(4, 8, max_value[2], 4);
C251 COMPILER V5.60.0,  transfer                                                           18/07/25  23:03:16  PAGE 4   

  190   3                      oled_show_num(5, 8, max_value[3], 4);
  191   3                      oled_show_num(6, 8, max_value[4], 4);
  192   3                      oled_show_num(7, 8, max_value[5], 4);
  193   3                      oled_show_num(8, 8, max_value[6], 4);
  194   3                                      
  195   3                                      // 根据标签显示对应的实时电感值
  196   3                      oled_show_num(2, 14, (uint16)result[0], 4); // HL
  197   3                      oled_show_num(3, 14, (uint16)result[1], 4); // VL
  198   3                      oled_show_num(4, 14, (uint16)result[2], 4); // HML
  199   3                      oled_show_num(5, 14, (uint16)result[3], 4); // HC
  200   3                      oled_show_num(6, 14, (uint16)result[4], 4); // HMR
  201   3                      oled_show_num(7, 14, (uint16)result[5], 4); // VR
  202   3                      oled_show_num(8, 14, (uint16)result[6], 4); // HR
  203   3                  }
  204   2                  break;
  205   2      
  206   2              case PID_PARA:
  207   2                  {
  208   3                      oled_show_string(1, 8, "pidpara");
  209   3                      
  210   3                      // 显示PID参数名称，选中项前添加'>'标记
  211   3                      oled_show_string(2, 1, selected_item == 0 ? ">S_Kp:" : "S_Kp: ");
  212   3                      oled_show_string(3, 1, selected_item == 1 ? ">S_Ki:" : "S_Ki: ");
  213   3                      oled_show_string(4, 1, selected_item == 2 ? ">T_Kp:" : "T_Kp: ");
  214   3                      oled_show_string(5, 1, selected_item == 3 ? ">T_Kd:" : "T_Kd: ");
  215   3                      oled_show_string(6, 1, selected_item == 4 ? ">A_Kp:" : "A_Kp: ");
  216   3                      oled_show_string(7, 1, selected_item == 5 ? ">A_Kd:" : "A_Kd: ");
  217   3      
  218   3                      oled_show_float(2, 8, SpeedPID.kp);
  219   3                      oled_show_float(3, 8, SpeedPID.ki);
  220   3                      oled_show_float(4, 8, TurnPID.kp);
  221   3                      oled_show_float(5, 8, TurnPID.kd);
  222   3                      oled_show_float(6, 8, angle_kp);
  223   3                      oled_show_float(7, 8, angle_kd);
  224   3                  }
  225   2                  break;
  226   2      
  227   2              case ISLAND_PARA:
  228   2                  {
  229   3                      // 显示入环岛参数
  230   3                      oled_show_string(1, 10, "In Island");
  231   3                      oled_show_string(2, 1, selected_item == 0 ? ">ipos:" : "ipos: ");
  232   3                      oled_show_num(2, 10, intoisland_pos, 3);
  233   3                      oled_show_string(3, 1, selected_item == 1 ? ">istr_d:" : "istr_d: ");
  234   3                      oled_show_num(3, 10, intoisland_str_dist, 5);
  235   3                      oled_show_string(4, 1, selected_item == 2 ? ">iall_d:" : "iall_d: ");
  236   3                      oled_show_num(4, 10, intoisland_all_dist, 5);
  237   3                      
  238   3                      // 显示出环岛参数
  239   3                      oled_show_string(5, 10, "Out Island");
  240   3                      oled_show_string(6, 1, selected_item == 3 ? ">opos:" : "opos: ");
  241   3                      oled_show_num(6, 10, outisland_pos, 3);
  242   3                      oled_show_string(7, 1, selected_item == 4 ? ">oturn_d:" : "oturn_d: ");
  243   3                      oled_show_num(7, 10, outisland_turn_dist, 5);
  244   3                      oled_show_string(8, 1, selected_item == 5 ? ">oall_d:" : "oall_d: ");
  245   3                      oled_show_num(8, 10, outisland_all_dist, 5);
  246   3                  }
  247   2                  break;
  248   2              case CHARGE:
  249   2                  {
  250   3                      oled_show_string(1, 1, "charge");
  251   3                      oled_show_string(2, 1, "power:");
  252   3                      oled_show_num(2, 8, power_voltage, 4);
  253   3      
  254   3                      if (power_voltage > 1300)
  255   3                      {
C251 COMPILER V5.60.0,  transfer                                                           18/07/25  23:03:16  PAGE 5   

  256   4                          startKeyFlag = 1; // 充电完成
  257   4                          selected_item = 0;
  258   4                          oled_clear();
  259   4                          prev_state = CHARGE;
  260   4                          car_state = RUNNING;
  261   4                      }
  262   3                  }
  263   2                  break;
  264   2              
  265   2              default:
  266   2                  break;
  267   2          }
  268   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =      2979     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =        19     ------
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =       351     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
