C251 COMPILER V5.60.0,  transfer                                                           14/07/25  14:27:40  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE transfer
OBJECT MODULE PLACED IN .\Out_File\transfer.obj
COMPILER INVOKED BY: D:\Software\Keil5\c251v560\C251\BIN\C251.EXE ..\USER\src\transfer.c LARGE INTR2 WARNINGLEVEL(3) OPT
                    -IMIZE(0,SPEED) BROWSE INCDIR(..\USER\inc;..\USER\src;..\libraries;..\seekfree_libraries;..\seekfree_peripheral) DEBUG PR
                    -INT(.\Out_File\transfer.lst) OBJECT(.\Out_File\transfer.obj) 

stmt  level    source

    1          #include "transfer.h"
    2          #include "OLED.h"
    3          #include "electromagnetic_tracking.h"
    4          #include "pid.h"
    5          #include "at24c16.h"
    6          
    7          Key_t key[4] = {0, 0, 0, 0};
    8          enum state car_state; 
    9          uint8 selected_item = 0; // 当前选中的项目索引
   10          
   11          
   12          volatile uint8_t startKeyFlag = 0, uartSendFlag = 1;
   13          
   14          void key_task(void)
   15          {
   16   1              if (key[0].flag == 1)
   17   1              {
   18   2      //        enum state prev_state = car_state;   // 记录切换前状态
   19   2      //        if (car_state < RUNNING)
   20   2      //        {
   21   2      //            car_state++;
   22   2      //            oled_clear();
   23   2      //            selected_item = 0; // 切换状态时重置选中项
   24   2      
   25   2      //            /* 若从 PID_PARA 切换到 CHARGE，保存参数 */
   26   2      //            if(prev_state == PID_PARA && car_state == CHARGE)
   27   2      //            {
   28   2      //                save_parameters_to_eeprom();
   29   2      //            }
   30   2      //        }
   31   2                      
   32   2                      if (startKeyFlag == 1)
   33   2                      {
   34   3                              set_motor_pwm(0, 0);
   35   3      
   36   3                              pid_clean(&SpeedPID);
   37   3                              pid_clean(&TurnPID);
   38   3                              
   39   3                              uartSendFlag = startKeyFlag = 0;
   40   3                      }
   41   2                      else
   42   2                      {
   43   3                              delay_ms(2000);
   44   3                              uartSendFlag = startKeyFlag = 1;
   45   3                      }
   46   2                      
   47   2                      key[0].flag = 0;
   48   2              }
   49   1      
   50   1              if (key[1].flag == 1)
   51   1              {
   52   2              // 按键1作为选择按键
   53   2              switch (car_state)
   54   2              {
   55   3                  case ELECT_PARA:
   56   3                      // 在电感参数界面，最多7个选项(max_value数组)
   57   3                      selected_item = (selected_item + 1) % 7;
C251 COMPILER V5.60.0,  transfer                                                           14/07/25  14:27:40  PAGE 2   

   58   3                      break;
   59   3                      
   60   3                  case PID_PARA:
   61   3                      // 在PID参数界面，最多6个选项(SpeedPID和TurnPID的kp,ki,kd)
   62   3                      selected_item = (selected_item + 1) % 6;
   63   3                      break;
   64   3                      
   65   3                  default:
   66   3                      break;
   67   3              }
   68   2                      
   69   2                      key[1].flag = 0;
   70   2              }
   71   1      
   72   1              if (key[2].flag == 1)
   73   1              {
   74   2              // 按键2作为增加值的按键
   75   2              switch (car_state)
   76   2              {
   77   3                  case ELECT_PARA:
   78   3                      // 增加选中的max_value值
   79   3                      if (selected_item < 7)
   80   3                      {
   81   4                          max_value[selected_item] += 10; // 每次增加10
   82   4                      }
   83   3                      break;
   84   3                      
   85   3                  case PID_PARA:
   86   3                      // 增加选中的PID参数
   87   3                      if (selected_item == 0) SpeedPID.kp += 0.1f;
   88   3                      else if (selected_item == 1) SpeedPID.ki += 0.1f;
   89   3                      else if (selected_item == 2) SpeedPID.kd += 0.1f;
   90   3                      else if (selected_item == 3) TurnPID.kp += 0.1f;
   91   3                      else if (selected_item == 4) TurnPID.ki += 0.1f;
   92   3                      else if (selected_item == 5) TurnPID.kd += 0.1f;
   93   3                      break;
   94   3                      
   95   3                  default:
   96   3                      break;
   97   3              }
   98   2                      
   99   2                      key[2].flag = 0;
  100   2              }
  101   1      
  102   1              if (key[3].flag == 1)
  103   1              {
  104   2              // 按键3作为减少值的按键
  105   2              switch (car_state)
  106   2              {
  107   3                  case ELECT_PARA:
  108   3                      // 减少选中的max_value值
  109   3                      if (selected_item < 7 && max_value[selected_item] >= 10)
  110   3                      {
  111   4                          max_value[selected_item] -= 10; // 每次减少10
  112   4                      }
  113   3                      break;
  114   3                      
  115   3                  case PID_PARA:
  116   3                      // 减少选中的PID参数
  117   3                      if (selected_item == 0 && SpeedPID.kp >= 0.1f) SpeedPID.kp -= 0.1f;
  118   3                      else if (selected_item == 1 && SpeedPID.ki >= 0.1f) SpeedPID.ki -= 0.1f;
  119   3                      else if (selected_item == 2 && SpeedPID.kd >= 0.1f) SpeedPID.kd -= 0.1f;
  120   3                      else if (selected_item == 3 && TurnPID.kp >= 0.1f) TurnPID.kp -= 0.1f;
  121   3                      else if (selected_item == 4 && TurnPID.ki >= 0.1f) TurnPID.ki -= 0.1f;
  122   3                      else if (selected_item == 5 && TurnPID.kd >= 0.1f) TurnPID.kd -= 0.1f;
  123   3                      break;
C251 COMPILER V5.60.0,  transfer                                                           14/07/25  14:27:40  PAGE 3   

  124   3                      
  125   3                  default:
  126   3                      break;
  127   3              }
  128   2                      
  129   2                      key[3].flag = 0;
  130   2              }
  131   1      }
  132          
  133          /* 8行，21列*/
  134          void display_task(void)
  135          {
  136   1          switch (car_state)
  137   1          {
  138   2              case ELECT_PARA:
  139   2                  {
  140   3                      oled_show_string(1, 8, "max_v:");
  141   3                      
  142   3                      // 显示电感名称，选中项前添加'>'标记
  143   3                      oled_show_string(2, 1, selected_item == 0 ? ">HL :" : "HL :");
  144   3                      oled_show_string(3, 1, selected_item == 1 ? ">HML:" : "HML:");
  145   3                      oled_show_string(4, 1, selected_item == 2 ? ">HC :" : "HC :");
  146   3                      oled_show_string(5, 1, selected_item == 3 ? ">HMR:" : "HMR:");
  147   3                      oled_show_string(6, 1, selected_item == 4 ? ">VR :" : "VR :");
  148   3                      oled_show_string(7, 1, selected_item == 5 ? ">HR :" : "HR :");
  149   3                      oled_show_string(8, 1, selected_item == 6 ? ">VL :" : "VL :");
  150   3      
  151   3                      oled_show_num(2, 8, max_value[0], 4);
  152   3                      oled_show_num(3, 8, max_value[1], 4);
  153   3                      oled_show_num(4, 8, max_value[2], 4);
  154   3                      oled_show_num(5, 8, max_value[3], 4);
  155   3                      oled_show_num(6, 8, max_value[4], 4);
  156   3                      oled_show_num(7, 8, max_value[5], 4);
  157   3                      oled_show_num(8, 8, max_value[6], 4);
  158   3                  }
  159   2                  break;
  160   2      
  161   2              case PID_PARA:
  162   2                  {
  163   3                      oled_show_string(1, 8, "pidpara");
  164   3                      
  165   3                      // 显示PID参数名称，选中项前添加'>'标记
  166   3                      oled_show_string(2, 1, selected_item == 0 ? ">S_Kp:" : "S_Kp:");
  167   3                      oled_show_string(3, 1, selected_item == 1 ? ">S_Ki:" : "S_Ki:");
  168   3                      oled_show_string(4, 1, selected_item == 2 ? ">S_Kd:" : "S_Kd:");
  169   3                      oled_show_string(5, 1, selected_item == 3 ? ">T_Kp:" : "T_Kp:");
  170   3                      oled_show_string(6, 1, selected_item == 4 ? ">T_Ki:" : "T_Ki:");
  171   3                      oled_show_string(7, 1, selected_item == 5 ? ">T_Kd:" : "T_Kd:");
  172   3      
  173   3                      oled_show_float(2, 8, SpeedPID.kp);
  174   3                      oled_show_float(3, 8, SpeedPID.ki);
  175   3                      oled_show_float(4, 8, SpeedPID.kd);
  176   3                      oled_show_float(5, 8, TurnPID.kp);
  177   3                      oled_show_float(6, 8, TurnPID.ki);
  178   3                      oled_show_float(7, 8, TurnPID.kd);
  179   3                  }
  180   2                  break;
  181   2      
  182   2              case CHARGE:
  183   2                  {
  184   3                      oled_show_string(1, 1, "charge");
  185   3                  }
  186   2                  break;
  187   2      
  188   2              case RUNNING:
  189   2                  {
C251 COMPILER V5.60.0,  transfer                                                           14/07/25  14:27:40  PAGE 4   

  190   3                      oled_show_string(1, 1, "running");
  191   3                  }
  192   2                  break;
  193   2              
  194   2              default:
  195   2                  break;
  196   2          }
  197   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =      2075     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =        17     ------
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =       220     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
