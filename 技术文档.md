# 基于DMA的电感数据处理方案设计

## 1. 方案概述

原方案采用传统ADC单次采集模式读取电感数据，新方案基于ADC-DMA转换模式，能够自动完成多次采样并计算平均值，极大地提高了采样效率和稳定性。

## 2. 技术实现对比

### 2.1 原实现方式（electromagnetic_tracking.c）
- 采用单次ADC采样：每次需要CPU主动调用`adc_once()`函数进行单次采样
- 使用软件滤波：需要软件维护历史数据缓冲区和滤波算法（均值滤波、中值滤波等）
- 占用CPU资源较多：CPU需参与每次采样和滤波过程

### 2.2 新实现方式（DMA模式）
- 采用ADC-DMA硬件自动采样：设置完成后，DMA自动采集指定次数并存入内存
- 硬件平均：ADC转换完成后，DMA自动计算平均值并存储在预定位置
- 中断触发处理：DMA完成后通过中断通知CPU，CPU只需读取结果即可

## 3. 实现细节

### 3.1 DMA缓冲区结构
根据STC32G系列单片机DMA-ADC功能的特性，DMA缓冲区按以下格式组织：

| 偏移位置 | 数据说明 |
|---------|----------|
| 0 | 使能的第1通道的第1次ADC转换结果的高字节 |
| 1 | 使能的第1通道的第1次ADC转换结果的低字节 |
| 2 | 使能的第1通道的第2次ADC转换结果的高字节 |
| 3 | 使能的第1通道的第2次ADC转换结果的低字节 |
| ... | ... |
| 2n-2 | 使能的第1通道的第n次ADC转换结果的高字节 |
| 2n-1 | 使能的第1通道的第n次ADC转换结果的低字节 |
| 2n | 第1通道的ADC通道号 |
| 2n+1 | 第1通道n次ADC转换结果取完平均值之后的余数 |
| 2n+2 | 第1通道n次ADC转换结果平均值的高字节 |
| 2n+3 | 第1通道n次ADC转换结果平均值的低字节 |
| (2n+4)+0 | 使能的第2通道的第1次ADC转换结果的高字节 |
| ... | ... |

### 3.2 数据处理流程

1. **初始化阶段**
   - 初始化ADC：配置ADC工作参数（采样时间、工作频率等）
   - 初始化DMA：配置DMA通道、缓冲区地址、转换次数等
   - 触发第一次DMA-ADC转换

2. **数据采集阶段**
   - DMA自动采集每个通道指定次数的ADC值
   - 采集完成后，硬件自动计算平均值并存入缓冲区
   - 触发DMA完成中断（DmaADCFlag置1）

3. **数据处理阶段**
   - 中断服务程序设置标志位（DmaADCFlag）
   - 主循环检测到标志位后，直接从DMA缓冲区读取每个通道的平均值
   - 执行归一化处理和位置计算等后续操作
   - 触发新一轮DMA-ADC转换

### 3.3 关键参数设置

- **采样次数(ADC_TIMES)**：4次（可调整）
- **DMA缓冲区大小(ADC_DATA)**：2*ADC_TIMES+4（每通道）
- **平均值位置**：DmaAdBuffer[通道][2*ADC_TIMES+2]和DmaAdBuffer[通道][2*ADC_TIMES+3]

## 4. 优势分析

1. **降低CPU负载**
   - CPU不再参与采样过程，只负责后处理
   - 减少软件滤波的计算开销

2. **提高数据稳定性**
   - 硬件平均减少噪声影响
   - 多次采样提高数据可靠性

3. **提高实时性**
   - 采样过程并行化，减少等待时间
   - 处理流程简化，响应更快

4. **简化软件架构**
   - 无需维护复杂的滤波算法和历史数据
   - 代码逻辑更清晰，易于维护

## 5. 注意事项

1. **硬件资源占用**
   - DMA通道资源有限，需合理规划
   - 内存使用量增加（缓冲区空间）

2. **中断处理设计**
   - 需注意中断优先级设置
   - 中断服务程序应尽量简短

3. **同步处理**
   - 需确保数据读取与DMA写入不冲突
   - 使用标志位确保数据完整性 

## 6. average_filter函数实现细节

#### 6.1 实现思路

`average_filter`函数是电感数据处理的核心，其实现思路如下：

1. **DMA数据读取**：
   - 函数开头检查`DmaADCFlag`标志位
   - 从DMA缓冲区`DmaAdBuffer`读取7个电感通道的ADC平均值
   - 数据位于`DmaAdBuffer[通道][2*ADC_TIMES+2]`和`DmaAdBuffer[通道][2*ADC_TIMES+3]`

2. **递推均值滤波**：
   - 将当前ADC值存入历史数据数组`adc_fliter_data`
   - 应用递推均值滤波算法，计算滤波后的结果
   - 将滤波结果存入`result`数组，作为后续归一化处理的输入

#### 6.2 递推均值滤波原理

递推均值滤波是一种低计算复杂度的滤波方法，其核心公式为：

```
y(n) = α·x(n) + (1-α)·y(n-1)
```

其中：
- `y(n)`是当前滤波输出
- `x(n)`是当前采样值
- `y(n-1)`是上一次滤波输出
- `α`是滤波系数，范围0~1，值越小滤波效果越强

#### 6.3 与DMA采样的协同工作机制

- `average_filter`函数不需要等待DMA采样完成，可由主循环在检测到`DmaADCFlag=1`时调用
- 滤波处理完成后，主循环重新触发DMA采样（`DMA_ADC_TRIG()`）
- 这种机制保证了数据处理与采样的高效协同 